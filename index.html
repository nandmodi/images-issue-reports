<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Review Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .filters select, .filters input[type="text"] {
      padding: 8px;
      width: 200px;
    }

    .filters button {
      padding: 8px 16px;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .summary-block {
      background-color: #fff;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    .summary-block h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #f2f2f2;
      text-align: left;
    }

    .bar-cell {
      position: relative;
      height: 24px;
    }

    .bar-cell span {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background-color: #d1e3ff;
      z-index: 0;
    }

    .bar-cell div {
      position: relative;
      z-index: 1;
      padding-left: 5px;
    }
  </style>
</head>
<body>
  <h1>Image Review Dashboard</h1>

  <div class="filters">
    <input type="text" id="filterDate" placeholder="Filter by Date">
    <select id="filterType">
      <option value="">Select Image Type</option>
      <option value="Exterior">Exterior</option>
      <option value="Interior">Interior</option>
    </select>
    <select id="filterIssue">
      <option value="">Select Issue</option>
      <option value="Remove BG">Remove BG</option>
      <option value="See Through">See Through</option>
      <option value="Other">Other</option>
      <option value="InputSwap">InputSwap</option>
      <option value="Shadow & Reflection">Shadow & Reflection</option>
    </select>
    <select id="filterEnterprise">
      <option value="">Select Enterprise</option>
      <option value="Dealer Vision">Dealer Vision</option>
    </select>
    <button onclick="applyFilters()">Apply Filters</button>
  </div>

  <div class="grid-layout" id="summaryGrid">
    <!-- Summary sections will be inserted here -->
    <!--
      Section 1: Category-wise Issue Count
      Section 2: Rejected Comment (Grouped + Detailed)
      Section 3: AI Tag Distribution
      Section 4: Enterprise-wise Issue Count
    -->
  </div>
  <div style="text-align:center; margin-top: 20px;">
    <button onclick="downloadData()" style="padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Download All Data</button>
  </div>
  <div style="text-align:center; margin-top: 10px;">
    <button onclick="refreshCache()" style="padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Refresh Data</button>
    <p id="lastUpdated" style="margin-top: 5px; font-size: 0.9em; color: gray;"></p>
  </div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script>
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSMkhFFKjQAikk2pTrxLo6LfUKKMlqqdoUJ1QZP0wP-l-z505sK4P3v8s__wmarI8DbmEwWbY6gW3bQ/pub?gid=0&single=true&output=csv";
    let data = [];
let cachedData = JSON.parse(localStorage.getItem('cachedImageReviewData')) || [];

    function fetchData() {
  const lastUpdated = localStorage.getItem('imageReviewDataTimestamp');
  if (cachedData.length > 0 && lastUpdated) {
    data = cachedData;
    renderSummary();
    document.getElementById('lastUpdated').innerText = `Last updated: ${new Date(parseInt(lastUpdated)).toLocaleString()}`;
    return;
  }
  $.get(sheetUrl, function (csv) {
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
    data = parsed.data;
    cachedData = [...data];
    localStorage.setItem('cachedImageReviewData', JSON.stringify(cachedData));
    localStorage.setItem('imageReviewDataTimestamp', Date.now());
    renderSummary();
    document.getElementById('lastUpdated').innerText = `Last updated: ${new Date().toLocaleString()}`;
  });
}
  $.get(sheetUrl, function (csv) {
    const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
    data = parsed.data;
    cachedData = [...data];
    localStorage.setItem('cachedImageReviewData', JSON.stringify(cachedData));
    renderSummary();
  });
});
        data = parsed.data;
        renderSummary();
      });
    }

    function createSummaryBlock(title, summaryMap) {
      let html = `<div class='summary-block'><h2>${title}</h2><table>`;
      Object.entries(summaryMap).forEach(([key, count]) => {
        const pct = ((count / data.length) * 100).toFixed(2);
        html += `<tr><td>${key}</td><td>${count}</td><td class='bar-cell'><span style='width:${pct}%'>&nbsp;</span><div>${pct}%</div></td></tr>`;
      });
      html += `</table></div>`;
      return html;
    }

    function summarizeByField(fieldName, sourceData = data) {
  const summary = {};
  sourceData.forEach(row => {
    const key = row[fieldName] || "Other";
    summary[key] = (summary[key] || 0) + 1;
  });
  return summary;
};
      data.forEach(row => {
        const key = row[fieldName] || "Other";
        summary[key] = (summary[key] || 0) + 1;
      });
      return summary;
    }

    function renderSummary() {
  const grid = document.getElementById("summaryGrid");
  grid.innerHTML =
    createSummaryBlock("Category", summarizeByField("image_category")) +
    createSummaryBlock("Rejected Comment (Grouped)", summarizeByField("rejected_comment_group")) +
    createSummaryBlock("Rejected Comment (Detailed)", summarizeByField("rejected_comment")) +
    createSummaryBlock("AI Tag", summarizeByField("ai_tag")) +
    createSummaryBlock("Enterprise", summarizeByField("enterprise_name"));
}

    function applyFilters() {
  const dateVal = document.getElementById("filterDate").value.toLowerCase();
  const typeVal = document.getElementById("filterType").value;
  const issueVal = document.getElementById("filterIssue").value;
  const entVal = document.getElementById("filterEnterprise").value;

  const filtered = data.filter(row => {
    return (!dateVal || (row.createdDate || '').toLowerCase().includes(dateVal)) &&
           (!typeVal || row.image_category === typeVal) &&
           (!issueVal || row.rejected_comment === issueVal) &&
           (!entVal || row.enterprise_name === entVal);
  });

  const grid = document.getElementById("summaryGrid");
  grid.innerHTML =
    createSummaryBlock("Category", summarizeByField("image_category", filtered)) +
    createSummaryBlock("Rejected Comment (Grouped)", summarizeByField("rejected_comment_group", filtered)) +
    createSummaryBlock("Rejected Comment (Detailed)", summarizeByField("rejected_comment", filtered)) +
    createSummaryBlock("AI Tag", summarizeByField("ai_tag", filtered)) +
    createSummaryBlock("Enterprise", summarizeByField("enterprise_name", filtered));
}

    function downloadData() {
  if (!data.length) return alert('No data to download');
  const csv = Papa.unparse(data);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'image_review_data.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function refreshCache() {
  localStorage.removeItem('cachedImageReviewData');
  localStorage.removeItem('imageReviewDataTimestamp');
  location.reload();
}

window.onload = fetchData;
  </script>
</body>
</html>
